!function(e){var n={};function o(t){if(n[t])return n[t].exports;var c=n[t]={i:t,l:!1,exports:{}};return e[t].call(c.exports,c,c.exports,o),c.l=!0,c.exports}o.m=e,o.c=n,o.d=function(e,n,t){o.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:t})},o.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},o.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(n,"a",n),n},o.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},o.p="",o(o.s=1)}([function(e,n,o){"use strict";var t=function(e,n){var o=e.match(n);return o&&2==o.length?o[1]:null},c=function(e,n){for(var o=e.split(" "),t=new Array,c=0,i=0;i<o.length;i++)3===c&&(t[c++]=n),o[i]!==n&&(t[c++]=o[i]);return t.join(" ")},i=function(e,n){for(var o=e[n].split(" "),c=e.length-1;c>=0;c--){var i=t(e[c],/a=rtpmap:(\d+) CN\/\d+/i);if(i){var r=o.indexOf(i);-1!==r&&o.splice(r,1),e.splice(c,1)}}return e[n]=o.join(" "),e};e.exports={preferOpus:function(e){for(var n=e.split("\r\n"),o=0;o<n.length;o++)if(-1!==n[o].search("m=audio")){var r=o;break}if(null===r)return e;for(o=0;o<n.length;o++)if(-1!==n[o].search("opus/48000")){var a=t(n[o],/:(\d+) opus\/48000/i);a&&(n[r]=c(n[r],a));break}return e=(n=i(n,r)).join("\r\n")}}},function(e,n,o){"use strict";var t,c,i,r,a=o(0),s=(t=a)&&t.__esModule?t:{default:t};var d,l,u,f,m,p={audio:!0},g=0,h=!1,C=!1,v="null",w=null,b=null,y=document.createElement("audio");y.setAttribute("preload","auto"),y.load;var k=null,O=!1,T=1;function R(){var e=D;N.emit("disconnect room",{room:e}),I.getAudioTracks()[0].stop();for(var n=Object.keys(A),o=0;o<n.length;o++)A[n[o]].rtcConn.close(),delete A[n[o]];A={},I=null,D=null,d=null,g=Object.keys(A).length,x()}function S(e){e.on("room null",function(){console.log("invalid room"),k=null,y.srcObject=null,O=!1,w=null,b=null,x()}),e.on("src ice",function(n){n.room===w&&n.id===e.id?b.addIceCandidate(new RTCIceCandidate(n.candidate)).then(console.log("Ice Candidate added successfully")).catch(function(e){return console.log("ERROR on addIceCandidate: "+e)}):console.log("ICE Candidate not for me")}),e.on("src desc",function(n){n.room===w&&n.id===e.id?b.setRemoteDescription(new RTCSessionDescription(n.desc)).then(function(){console.log("Setting remote description success"),j(n.desc)}):console.log("ICE Candidate not for me")})}function j(e){b.createAnswer().then(function(e){b.setLocalDescription(new RTCSessionDescription(e)).then(function(){N.emit("peer new desc",{id:N.id,room:w,desc:e})})})}chrome.runtime.onConnect.addListener(function(e){l=e,e.onMessage.addListener(function(e){var n,o;"init"==e.type&&(N.emit("create room",e.roomName),chrome.tabs.onUpdated.addListener(function(e,n){n.title&&e===d&&(console.log(n.title),f=n.title,console.log("sending new title to all peers"),Object.keys(A).forEach(function(e){var n=A[e].dataChannel;if("open"===n.readyState){var o=JSON.stringify({title:f});n.send(o)}}),x())})),"play"==e.type&&(w||(w=e.roomName,console.log("Active session with ID: "+w+" found!"),N.emit("new peer",w),S(N),(b=new RTCPeerConnection(M,{optional:[{RtpDataChannels:!0}]})).onicecandidate=function(e){e.candidate?(N.emit("peer new ice",{id:N.id,room:w,candidate:e.candidate}),console.log(N.id)):console.log("No candidate for RTC connection")},b.ondatachannel=function(e){e.channel.onmessage=function(e){try{var n=JSON.parse(e.data);m=n.title,console.log(m),x()}catch(e){console.log(e)}}},b.onconnectionstatechange=function(e){switch(b.connectionState){case"connected":v="connected";break;case"connecting":v="connecting";break;case"disconnected":v="disconnected";break;case"failed":v="failed";break;case"closed":v="closed"}},b.ontrack=function(e){k=new MediaStream([e.track]);try{y.srcObject=k}catch(e){console.log(e)}},y.pause(),O=!1),w!=e.roomName&&(console.log("changing room"),w=e.roomName,N.emit("new peer",w),S(N),(b=new RTCPeerConnection(M)).onicecandidate=function(e){e.candidate?N.emit("peer new ice",{id:N.id,room:w,candidate:e.candidate}):console.log("No candidate for RTC connection")},b.ondatachannel=function(e){e.channel.onmessage=function(e){try{var n=JSON.parse(e.data);m=n.title,console.log(m)}catch(e){console.log(e)}}},b.ontrack=function(e){k=new MediaStream([e.track]);try{y.srcObject=k,y.play(),O=!0}catch(e){console.log(e)}}),O?(y.pause(),O=!1):(y.play(),O=!0),x()),"stopToonin"==e.type&&(N.emit("logoff",{from:N.id,to:w}),k=null,y.srcObject=null,O=!1,w=null,b=null,x()),"stopSharing"==e.type&&R(),"toggleMute"==e.type&&((C=!e.value)?Object.keys(A).forEach(function(e){var n=A[e].rtcConn;n.removeTrack(n.getSenders()[0])}):Object.keys(A).forEach(function(e){A[e].rtcConn.getSenders()[0].replaceTrack(c.stream.getAudioTracks()[0])})),"volume"==e.type&&(n=e.value,o=parseInt(n,10)/parseInt(100,10),T=o*o,console.log(o),h||b?b&&(y.volume=T):r.gain.value=T)})}),chrome.tabs.onRemoved.addListener(function(e,n){e===d&&R()}),chrome.runtime.onMessage.addListener(function(e,n,o){"extension_state"===e.message&&x()}),chrome.tabs.onUpdated.addListener(function(e,n){n.mutedInfo&&e===d&&(n.mutedInfo.muted?(h=!0,r.gain.value=0):(h=!1,r.gain.value=T),x())}),console.log("application script running");var I,D,N=io("https://www.toonin.ml:8443",{secure:!0}),A={},M={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:stun2.l.google.com:19302","stun:stun3.l.google.com:19302","stun:stun4.l.google.com:19302"]}]},E={offerToReceiveAudio:1};function x(){var e={roomID:D,tabID:d,playing:y.srcObject,room:w,muted:C,peerCounter:g,hostTitle:m,title:f,volume:T,tabMute:h,connectionState:v};chrome.runtime.sendMessage({message:"extension_state_from_background",data:e})}N.on("room created",function(e){console.log("New room created with ID: "+e),D=e,chrome.tabCapture.capture(p,function(e){if(e){var n=e.getAudioTracks();I=new MediaStream(n),u=new AudioContext,(r=u.createGain()).connect(u.destination),(i=u.createMediaStreamSource(I)).connect(r),r.gain.value=1,c=u.createMediaStreamDestination(),i.connect(c),console.log("Tab audio captured. Now sending url to injected content script"),chrome.tabs.query({active:!0,currentWindow:!0},function(e){var n=e[0];n&&(d=n.id,f=n.title,x())})}else console.error("Error starting tab capture: "+(chrome.runtime.lastError.message||"UNKNOWN"))})}),N.on("room creation failed",function(e){l.postMessage({type:"room creation fail",reason:e})}),N.on("peer joined",function(e){console.log("New peer has joined the room"),A[e.id]={id:e.id,room:e.room,iceCandidates:[]},g=Object.keys(A).length,x(),function(e){console.log("Starting new connection for peer: "+e);var n=new RTCPeerConnection(M,{optional:[{RtpDataChannels:!0}]});n.addTrack(c.stream.getAudioTracks()[0]),A[e].rtcConn=n,A[e].dataChannel=A[e].rtcConn.createDataChannel("mediaDescription"),A[e].rtcConn.onicecandidate=function(n){n.candidate?(A[e].iceCandidates.push(n.candidate),N.emit("src new ice",{id:e,room:D,candidate:n.candidate})):console.log("No candidate for RTC connection")},n.createOffer(E).then(function(o){s.default.preferOpus(o.sdp),n.setLocalDescription(new RTCSessionDescription(o)).then(function(){A[e].localDesc=o,N.emit("src new desc",{id:e,room:D,desc:o})})}),A[e].dataChannel.addEventListener("open",function(n){console.log("sending title to new peer"),A[e].dataChannel.send(JSON.stringify({title:f}))})}(e.id)}),N.on("peer ice",function(e){console.log("Ice Candidate from peer: "+e.id+" in room: "+e.room),console.log("Ice Candidate: "+e.candidate),D==e.room&&e.id in A?A[e.id].rtcConn.addIceCandidate(new RTCIceCandidate(e.candidate)).then(console.log("Ice Candidate added successfully for peer: "+e.id)).catch(function(e){console.log("Error on addIceCandidate: "+e)}):console.log("Ice Candidate not for me")}),N.on("peer desc",function(e){console.log("Answer description from peer: "+e.id+" in room: "+e.room),console.log("Answer description: "+e.desc),D==e.room&&e.id in A?A[e.id].rtcConn.setRemoteDescription(new RTCSessionDescription(e.desc)).then(function(){console.log("Remote description set successfully for peer: "+e.id)}).catch(function(e){console.log("Error on setRemoteDescription: "+e)}):console.log("Answer Description not for me")}),N.on("peer disconnected",function(e){console.log("peer disconnected");try{A[e.id].rtcConn.removeTrack(c.stream.getAudioTracks()[0])}catch(e){console.log(e)}A[e.id].rtcConn=void 0,delete A[e.id],g=Object.keys(A).length,x()}),N.on("host disconnected",function(){console.log("host disconnected"),k=null,y.srcObject=null,O=!1,w=null,b=null,x()})}]);