!function(e){var o={};function n(t){if(o[t])return o[t].exports;var r=o[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=o,n.d=function(e,o,t){n.o(e,o)||Object.defineProperty(e,o,{configurable:!1,enumerable:!0,get:t})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(o,"a",o),o},n.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},n.p="",n(n.s=0)}([function(e,o){console.log("Background script running");var n,t={audio:!0};function r(){chrome.tabs.executeScript({file:"js/lib/socket.io.js"},i)}function i(){chrome.tabs.executeScript({file:"js/inject.js"},function(){chrome.runtime.lastError?console.error(chrome.runtime.lastError.message):console.log("All scripts successfully loaded")})}chrome.runtime.onConnect.addListener(function(e){n=e,e.onMessage.addListener(function(e){console.log(e),"init"==e.type&&a.emit("create room")})}),chrome.browserAction.onClicked.addListener(function(){console.log("Starting Toonin Script Injection"),chrome.tabs.executeScript({file:"js/lib/adapter.js"},r)}),console.log("application script running");var c,s,a=io("http://18.217.134.32:8100"),d={};const l={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:stun2.l.google.com:19302","stun:stun3.l.google.com:19302","stun:stun4.l.google.com:19302"]}]},u={offerToReceiveAudio:1};a.on("room created",function(e){console.log("New room created with ID: "+e),s=e,n.postMessage({type:"roomID",roomID:e}),chrome.tabCapture.capture(t,function(e){if(!e)return void console.error("Error starting tab capture: "+(chrome.runtime.lastError.message||"UNKNOWN"));let o=e.getAudioTracks(),n=new MediaStream(o);window.audio=document.createElement("audio"),window.audio.srcObject=n,window.audio.play(),c=n,console.log("Tab audio captured. Now sending url to injected content script")})}),a.on("peer joined",function(e){console.log("New peer has joined the room"),d[e.id]={id:e.id,room:e.room,iceCandidates:[]},function(e){console.log("Starting new connection for peer: "+e);const o=new RTCPeerConnection(l);o.addStream(c),d[e].rtcConn=o,console.log(d),d[e].rtcConn.onicecandidate=function(o){o.candidate?(d[e].iceCandidates.push(o.candidate),a.emit("src new ice",{id:e,room:s,candidate:o.candidate})):console.log("No candidate for RTC connection")},o.createOffer(u).then(function(n){f(n.sdp),o.setLocalDescription(new RTCSessionDescription(n)).then(function(){d[e].localDesc=n,a.emit("src new desc",{id:e,room:s,desc:n})})})}(e.id)}),a.on("peer ice",function(e){console.log("Ice Candidate from peer: "+e.id+" in room: "+e.room),console.log("Ice Candidate: "+e.candidate),s==e.room&&e.id in d?d[e.id].rtcConn.addIceCandidate(new RTCIceCandidate(e.candidate)).then(console.log("Ice Candidate added successfully for peer: "+e.id)).catch(function(e){console.log("Error on addIceCandidate: "+e)}):console.log("Ice Candidate not for me")}),a.on("peer desc",function(e){console.log("Answer description from peer: "+e.id+" in room: "+e.room),console.log("Answer description: "+e.desc),s==e.room&&e.id in d?d[e.id].rtcConn.setRemoteDescription(new RTCSessionDescription(e.desc)).then(function(){console.log("Remote description set successfully for peer: "+e.id)}).catch(function(e){console.log("Error on setRemoteDescription: "+e)}):console.log("Answer Description not for me")});var f=function(e){for(var o=e.split("\r\n"),n=0;n<o.length;n++)if(-1!==o[n].search("m=audio")){var t=n;break}if(null===t)return e;for(n=0;n<o.length;n++)if(-1!==o[n].search("opus/48000")){var r=p(o[n],/:(\d+) opus\/48000/i);r&&(o[t]=m(o[t],r));break}return e=(o=g(o,t)).join("\r\n")},p=function(e,o){var n=e.match(o);return n&&2==n.length?n[1]:null},m=function(e,o){for(var n=e.split(" "),t=new Array,r=0,i=0;i<n.length;i++)3===r&&(t[r++]=o),n[i]!==o&&(t[r++]=n[i]);return t.join(" ")},g=function(e,o){for(var n=e[o].split(" "),t=e.length-1;t>=0;t--){var r=p(e[t],/a=rtpmap:(\d+) CN\/\d+/i);if(r){var i=n.indexOf(r);-1!==i&&n.splice(i,1),e.splice(t,1)}}return e[o]=n.join(" "),e}}]);